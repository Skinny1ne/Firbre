<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Durban Fibre Live â€“ Compare Overview</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { margin:0; height:100%; font-family: Arial, sans-serif; }
  #map { height:100%; width:100%; }

  /* Search box */
  #searchBox {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,0.95); padding:10px; border-radius:8px;
    display:flex; gap:10px; z-index:1000; width:90%; max-width:500px;
  }
  #searchBox input { flex:1; padding:8px; border-radius:4px; border:1px solid #ccc; }
  #searchBox button { padding:8px 12px; background:#0078ff; color:white; border:none; border-radius:4px; cursor:pointer; }
  #searchBox button:hover { background:#005bb5; }

  /* Autocomplete suggestions */
  #suggestions {
    position:absolute; top:50px; left:50%; transform:translateX(-50%);
    z-index:1000; background:white; width:90%; max-width:500px;
    border:1px solid #ccc; border-radius:4px; max-height:200px; overflow-y:auto;
  }
  #suggestions div { padding:8px; cursor:pointer; }
  #suggestions div:hover { background:#e0f0ff; }

  /* Results summary card */
  #results {
    position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    z-index:1000; background:rgba(255,255,255,0.95); padding:15px; border-radius:8px;
    width:90%; max-width:500px; text-align:left; box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  #results h2 { margin:0 0 5px 0; font-size:18px; }
  #results p { margin:4px 0; }
  #results ul { padding-left:20px; margin:5px 0; }
</style>
</head>
<body>

<div id="searchBox">
  <input type="text" id="address" placeholder="Enter Durban address">
  <button onclick="searchAddress()">Search</button>
</div>
<div id="suggestions"></div>
<div id="results">
  <p>Search for an address to see fibre availability, median speed, downtime, and reviews.</p>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Initialize map
const map = L.map('map').setView([-29.8587, 31.0218], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

// Marker
let marker = null;

// Dummy fibre coverage polygon for Durban (replace with real data later)
const coveragePolygon = L.polygon([
  [-29.870, 31.000],
  [-29.830, 31.000],
  [-29.830, 31.050],
  [-29.870, 31.050]
], {color: 'green', fillOpacity:0.2}).addTo(map);

const addressInput = document.getElementById('address');
const suggestionsBox = document.getElementById('suggestions');
const resultsDiv = document.getElementById('results');

// Dummy data for ISPs, median speeds, downtime, and reviews
const ispData = {
  "Vumatel": { speed:"50/50 Mbps", downtime:"30 min/month", reviews:"4.3/5" },
  "Openserve": { speed:"40/20 Mbps", downtime:"45 min/month", reviews:"3.9/5" },
  "Rain": { speed:"30/30 Mbps", downtime:"60 min/month", reviews:"4.0/5" }
};

// Autocomplete suggestions (Nominatim)
addressInput.addEventListener('input', async ()=>{
  const query = addressInput.value;
  if(query.length < 3){ suggestionsBox.innerHTML=''; return; }

  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&viewbox=30.7,-29.0,31.3,-29.2&bounded=1&countrycodes=za`;
  const res = await fetch(url);
  const data = await res.json();
  suggestionsBox.innerHTML='';
  data.forEach(item=>{
    const div = document.createElement('div');
    div.textContent = item.display_name;
    div.onclick = () => {
      addressInput.value = item.display_name;
      suggestionsBox.innerHTML='';
      searchAddress(item.lat,item.lon);
    };
    suggestionsBox.appendChild(div);
  });
});

// Search address and show summary
async function searchAddress(latParam, lonParam){
  let lat = latParam, lon = lonParam;
  if(!lat || !lon){
    const query = addressInput.value;
    if(!query) return;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=1&viewbox=30.7,-29.0,31.3,-29.2&bounded=1&countrycodes=za`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.length){ resultsDiv.innerHTML="Address not found in Durban."; return; }
    lat = data[0].lat; lon = data[0].lon;
  }

  // Move map and add marker
  map.setView([lat,lon],15);
  if(marker) map.removeLayer(marker);
  marker = L.marker([lat,lon]).addTo(map).bindPopup(addressInput.value).openPopup();

  // Check if point inside polygon
  const point = L.latLng(lat, lon);
  const inside = coveragePolygon.getBounds().contains(point);

  if(!inside){
    resultsDiv.innerHTML = "<b>No fibre coverage at this address.</b>";
    return;
  }

  // Build summary for available ISPs
  let html = "<h2>Fibre Coverage Available</h2>";
  Object.keys(ispData).forEach(isp=>{
    html += `<p><b>${isp}</b></p><ul>`;
    html += `<li>Median Speed: ${ispData[isp].speed}</li>`;
    html += `<li>Downtime: ${ispData[isp].downtime}</li>`;
    html += `<li>Reviews: ${ispData[isp].reviews}</li>`;
    html += `</ul>`;
  });
  resultsDiv.innerHTML = html;
}
</script>

</body>
</html>
